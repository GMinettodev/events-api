<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/eventService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/eventService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const EventModel = require('../models/eventModel');
const UserModel = require('../models/userModel');
const createError = require('http-errors');

const dayjs = require('dayjs');
const utc = require('dayjs/plugin/utc');
dayjs.extend(utc);

/**
 * Formats a date to the MySQL accepted format: 'YYYY-MM-DD HH:mm:ss'
 * @param {Date|string} date - The date to format.
 * @returns {string} Formatted date for MySQL.
 */
function formatDateForMySQL(date) {
  return dayjs.utc(date).format('YYYY-MM-DD HH:mm:ss');
}

/**
 * Service layer for managing events.
 */
class EventService {
  /**
   * Retrieves all events.
   * @returns {Promise&lt;Array&lt;Object>>} List of event objects.
   */
  static async getEvents() {
    return EventModel.findAll();
  }

  /**
   * Creates a new event.
   * @param {Object} eventData - Event data to create.
   * @param {string} eventData.name - Name of the event.
   * @param {string|Date} eventData.date - Date of the event.
   * @param {string} [eventData.description] - Optional description of the event.
   * @param {string|number} userId - ID of the user creating the event.
   * @throws {HttpError} Throws error if validation fails.
   * @returns {Promise&lt;number>} ID of the newly created event.
   */
  static async createEvent(eventData, userId) {
    if (!userId) {
      throw createError(404, 'User ID is required to create an event');
    }

    const eventDate = dayjs.utc(eventData.date).startOf('day');
    const today = dayjs.utc().startOf('day');

    if (!eventDate.isValid()) {
      throw createError(400, 'Invalid event date format');
    }

    if (eventDate.isBefore(today)) {
      throw createError(400, 'Event date cannot be in the past');
    }

    const eventToCreate = {
      ...eventData,
      date: formatDateForMySQL(eventDate),
      created_by: userId,
      created_at: new Date(),
    };

    const insertedId = await EventModel.create(eventToCreate);

    return insertedId;
  }

  /**
   * Updates an existing event.
   * @param {string|number} id - ID of the event to update.
   * @param {Object} eventData - Event data to update.
   * @param {string|Date} [eventData.date] - New date for the event.
   * @param {string} [eventData.name] - New name for the event.
   * @param {string} [eventData.description] - New description.
   * @param {string|number} userId - ID of the user performing the update.
   * @throws {HttpError} Throws error if validation fails or event not found.
   * @returns {Promise&lt;Object>} The updated event object.
   */
  static async updateEvent(id, eventData, userId) {
    if (!userId) {
      throw createError(401, 'User ID is required to update an event');
    }

    const existingEvent = await EventModel.findById(id);
    if (!existingEvent) {
      throw createError(404, 'Event not found');
    }

    const { created_at, created_by, ...fieldsToUpdate } = eventData;

    if (fieldsToUpdate.date) {
      const eventDate = dayjs.utc(fieldsToUpdate.date).startOf('day');
      const today = dayjs.utc().startOf('day');

      if (!eventDate.isValid()) {
        throw createError(400, 'Invalid event date format');
      }

      if (eventDate.isBefore(today)) {
        throw createError(400, 'Event date cannot be in the past');
      }

      fieldsToUpdate.date = formatDateForMySQL(eventDate);
    }

    const updatedEvent = await EventModel.update(id, fieldsToUpdate);

    return updatedEvent;
  }

  /**
   * Lists events with user info for the dashboard.
   * @returns {Promise&lt;Array&lt;Object>>} List of events with associated user details.
   */
  static async listEventsForDashboard() {
    return EventModel.getAllEventsWithUser();
  }

  /**
   * Deletes an event.
   * @param {string|number} id - ID of the event to delete.
   * @param {string} userEmail - Email of the user attempting the deletion.
   * @throws {HttpError} Throws error if unauthorized or if entities not found.
   * @returns {Promise&lt;Object>} Confirmation message.
   */
  static async deleteEvent(id, userEmail) {
    if (!userEmail) {
      throw createError(401, 'User email is required to delete an event');
    }

    const existingEvent = await EventModel.findById(id);
    if (!existingEvent) {
      throw createError(404, 'Event not found');
    }

    const user = await UserModel.findByEmail(userEmail);
    if (!user) {
      throw createError(404, 'User not found');
    }

    if (existingEvent.created_by !== user.id &amp;&amp; user.role !== 'admin') {
      throw createError(403, 'You are not authorized to delete this event');
    }

    await EventModel.delete(id);

    return { message: 'Event deleted successfully' };
  }
}

module.exports = EventService;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DashboardController.html">DashboardController</a></li><li><a href="EventController.html">EventController</a></li><li><a href="EventModel.html">EventModel</a></li><li><a href="EventService.html">EventService</a></li><li><a href="UserController.html">UserController</a></li><li><a href="UserModel.html">UserModel</a></li><li><a href="UserService.html">UserService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Oct 15 2025 10:56:04 GMT-0300 (Horário Padrão de Brasília)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
